<section class="page">
  <header class="page-header">
    <div>
      <h1 class="page-title">Tags</h1>
      <p class="page-subtitle">Create and manage tag dictionary.</p>
    </div>
    <div class="actions">
      <button
        mat-raised-button
        color="primary"
        (click)="applyLatestHeuristicsToAllProjects()"
        [disabled]="isApplyHeuristicsBusy()"
        data-testid="tag-apply-heuristics-all-btn"
      >
        Apply latest heuristics to all projects
      </button>
    </div>
  </header>

  <p class="apply-heuristics-status" *ngIf="applyHeuristicsStatus()" data-testid="tag-apply-heuristics-status">
    {{ applyHeuristicsStatus() }}
  </p>

  <mat-card class="add-card">
    <mat-card-title>Add tag</mat-card-title>
    <mat-card-content class="add-row">
      <mat-form-field appearance="outline" class="add-input">
        <mat-label>Tag name</mat-label>
        <input
          matInput
          [value]="newTagName"
          (input)="newTagName = $any($event.target).value"
          data-testid="tag-add-input"
        />
      </mat-form-field>
      <button mat-raised-button color="primary" (click)="addTag()" data-testid="tag-add-btn">
        Add
      </button>
    </mat-card-content>
  </mat-card>

  <mat-card class="list-card">
    <mat-card-title>Tag list</mat-card-title>
    <mat-card-content>
      <div class="empty" *ngIf="tags().length === 0">No tags yet.</div>

      <div class="tag-row" *ngFor="let tag of tags()" data-testid="tag-row">
        <ng-container *ngIf="editTagId !== tag.id; else editRow">
          <div class="name-wrap">
            <div class="name">{{ tag.name }}</div>
            <span class="system-badge" *ngIf="tag.isSystem" data-testid="tag-system-badge">Seeded</span>
          </div>
          <div class="meta">Updated {{ tag.updatedAt | date: 'short' }}</div>
          <div class="usage">
            <button
              mat-stroked-button
              (click)="openProjects(tag)"
              [attr.data-testid]="'tag-project-count-btn-' + tag.id"
            >
              Projects {{ tag.projectCount }}
            </button>
          </div>
          <div class="actions">
            <button mat-stroked-button (click)="beginEdit(tag)" data-testid="tag-edit-btn">Edit</button>
            <button
              mat-stroked-button
              color="warn"
              *ngIf="!tag.isSystem"
              (click)="deleteTag(tag)"
              data-testid="tag-delete-btn"
            >
              Delete
            </button>
          </div>
        </ng-container>

        <ng-template #editRow>
          <mat-form-field appearance="outline" class="edit-input">
            <mat-label>Edit tag</mat-label>
            <input
              matInput
              [value]="editTagName"
              (input)="editTagName = $any($event.target).value"
              data-testid="tag-edit-input"
            />
          </mat-form-field>
          <div class="actions">
            <button mat-stroked-button color="primary" (click)="saveEdit(tag.id)" data-testid="tag-save-btn">
              Save
            </button>
            <button mat-stroked-button (click)="cancelEdit()" data-testid="tag-cancel-btn">Cancel</button>
          </div>
        </ng-template>
      </div>
    </mat-card-content>
  </mat-card>
</section>
