<div class="list-toolbar">
  <mat-form-field appearance="outline" class="toolbar-field">
    <mat-label>Search</mat-label>
    <input
      matInput
      placeholder="Search by project name"
      [value]="searchTerm"
      (input)="searchTerm = $any($event.target).value"
      data-testid="project-suggest-search"
    />
  </mat-form-field>

  <mat-form-field appearance="outline" class="toolbar-field">
    <mat-label>Sort</mat-label>
    <mat-select
      [value]="sortKey"
      (selectionChange)="sortKey = $event.value"
      data-testid="project-suggest-sort"
    >
      <mat-option value="name">Name</mat-option>
      <mat-option value="score">Score</mat-option>
      <mat-option value="createdAt">Created</mat-option>
    </mat-select>
  </mat-form-field>

  <mat-button-toggle-group
    class="sort-dir"
    [value]="sortDir"
    (change)="sortDir = $event.value"
    aria-label="Project suggestions sort direction"
    data-testid="project-suggest-sort-dir"
  >
    <mat-button-toggle value="asc">Asc</mat-button-toggle>
    <mat-button-toggle value="desc">Desc</mat-button-toggle>
  </mat-button-toggle-group>

  <mat-button-toggle-group
    *ngIf="mode === 'suggestions'"
    class="scope-toggle"
    [value]="scope"
    (change)="scope = $event.value"
    aria-label="Project suggestions scope"
    data-testid="project-suggest-scope"
  >
    <mat-button-toggle value="pending">Pending</mat-button-toggle>
    <mat-button-toggle value="archive">Archive</mat-button-toggle>
  </mat-button-toggle-group>

  <span class="spacer"></span>

  <mat-button-toggle-group
    class="layout-toggle"
    [value]="layout"
    (change)="layout = $event.value"
    aria-label="Project suggestions layout"
    data-testid="project-suggest-layout"
  >
    <mat-button-toggle value="list">List</mat-button-toggle>
    <mat-button-toggle value="grid">Grid</mat-button-toggle>
  </mat-button-toggle-group>

  <label class="grid-size" data-testid="project-suggest-grid-size-wrap">
    <span>Card size (grid)</span>
    <input
      type="range"
      min="85"
      max="130"
      step="5"
      [disabled]="layout !== 'grid'"
      [value]="gridCardSizePercent"
      (input)="gridCardSizePercent = +$any($event.target).value"
      data-testid="project-suggest-grid-size"
    />
  </label>

  <button
    *ngIf="mode === 'suggestions'"
    mat-stroked-button
    data-testid="project-suggest-export-archive"
    #exportDone="matTooltip"
    matTooltip="Exported"
    matTooltipPosition="above"
    (click)="exportArchiveJson(exportDone)"
  >
    Export archive JSON
  </button>
  <button
    *ngIf="mode === 'suggestions'"
    mat-stroked-button
    data-testid="project-suggest-open-archive-folder"
    (click)="openArchiveFolder()"
  >
    Open export folder
  </button>
</div>

<div
  class="suggestion-list"
  [class.layout-grid]="layout === 'grid'"
  [style.--grid-card-scale]="gridScaleFactor"
  data-testid="project-suggest-list"
>
  <mat-card
    *ngFor="let item of visibleItems"
    class="suggestion-card"
    [class.is-open]="layout === 'grid' ? true : item.id === openId"
    [class.is-grid]="layout === 'grid'"
  >
    <div class="header-row" (click)="toggleDetails(item.id)" role="button" tabindex="0">
      <div class="title-block">
        <span class="name" data-testid="project-name">{{ item.name }}</span>
        <span class="kind">{{ item.kind }}</span>
      </div>
      <div class="meta">
        <span class="score">Score {{ item.score }}</span>
        <span class="status" [attr.data-status]="item.status">{{ item.status }}</span>
        <span class="chevron" aria-hidden="true"></span>
      </div>
    </div>

    <div
      class="details-wrap"
      [attr.data-open]="layout === 'grid' ? true : item.id === openId"
    >
      <div class="details">
        <div class="detail-row path-row">
          <span class="detail-label">Path</span>
          <button
            type="button"
            class="detail-value path-value path-menu-trigger"
            [matMenuTriggerFor]="pathMenu"
            data-testid="path-menu-trigger"
          >
            <span
              #pathValue
              class="path-value-text"
              [matTooltip]="item.path"
              [matTooltipDisabled]="!isOverflowing(pathValue)"
              matTooltipClass="path-tooltip"
              matTooltipPositionAtOrigin="true"
            >
              {{ item.path }}
            </span>
          </button>
          <mat-menu #pathMenu="matMenu">
            <button
              mat-menu-item
              data-testid="path-copy-btn"
              (click)="copyPath(item.path)"
            >
              Copy path
            </button>
            <button
              mat-menu-item
              data-testid="path-open-btn"
              (click)="openPath(item.path)"
            >
              Open in Explorer
            </button>
          </mat-menu>
        </div>
        <div class="detail-row">
          <span class="detail-label">Reason</span>
          <button
            type="button"
            class="detail-value reason-copy-btn"
            data-testid="reason-copy-btn"
            (click)="copyReason(item.reason)"
          >
            <strong>{{ item.reason }}</strong>
          </button>
        </div>
        <div class="detail-row">
          <span class="detail-label">Extensions</span>
          <strong>{{ item.extSummary }}</strong>
        </div>

        <div class="detail-row">
          <span class="detail-label">Markers</span>
          <div class="chip-row">
            <span class="chip" *ngFor="let marker of item.markers">{{ marker }}</span>
            <span class="chip chip-muted" *ngFor="let hint of item.techHints">{{ hint }}</span>
          </div>
        </div>
      </div>

      <div
        class="actions"
        *ngIf="(mode !== 'suggestions' || scope !== 'archive') || item.status === 'rejected'"
      >
        <button
          mat-stroked-button
          color="primary"
          *ngIf="(mode !== 'suggestions' || scope !== 'archive') || item.status === 'rejected'"
          (click)="setStatus(item.id, 'accepted')"
        >
          Accept
        </button>
        <button
          mat-stroked-button
          color="warn"
          *ngIf="mode !== 'suggestions' || scope !== 'archive'"
          (click)="setStatus(item.id, 'rejected')"
        >
          Reject
        </button>
      </div>
    </div>
  </mat-card>
</div>
